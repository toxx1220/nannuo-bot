name: Release

# Trigger on version tags only â€” pushes to main (from this workflow) won't re-trigger.
on:
    push:
        tags:
            - "v*"

permissions:
    contents: write
    checks: read

jobs:
    build-and-release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout (full history for version detection)
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Setup JDK
              uses: actions/setup-java@v5
              with:
                  distribution: "temurin"
                  java-version: "25"

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v5

            - name: Build fat JAR
              run: ./gradlew shadowJar --no-daemon

            - name: Prepare release artifact
              id: jar
              run: |
                  # Rename to a stable name so the download URL is predictable
                  JAR_SRC=$(ls build/libs/*-all.jar)
                  JAR_DEST="build/libs/nannuo-bot.jar"
                  cp "$JAR_SRC" "$JAR_DEST"
                  echo "path=$JAR_DEST" >> "$GITHUB_OUTPUT"

            - name: Compute SRI hash
              id: hash
              run: |
                  SRI=$(openssl dgst -sha256 -binary "${{ steps.jar.outputs.path }}" | base64 -w0)
                  echo "sri=sha256-${SRI}" >> "$GITHUB_OUTPUT"

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: ${{ steps.jar.outputs.path }}
                  generate_release_notes: true

            - name: Update jar-source.nix and push to main
              id: push
              env:
                  TAG: ${{ github.ref_name }}
                  HASH: ${{ steps.hash.outputs.sri }}
              run: |
                  # Switch to main to commit and push
                  git checkout main
                  git pull --ff-only origin main

                  # Write the updated jar-source.nix
                  cat > jar-source.nix << EOF
                  # Auto-updated by GitHub Actions on each tagged release.
                  # To update manually, run: nix run .#update-jar -- <tag>
                  {
                    url = "https://github.com/toxx1220/nannuo-bot/releases/download/${TAG}/nannuo-bot.jar";
                    hash = "${HASH}";
                  }
                  EOF

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add jar-source.nix
                  if ! git diff --staged --quiet; then
                    git commit -m "chore: update JAR hash for ${TAG}"
                    git push origin main
                  else
                    echo "No changes to commit"
                  fi
                  echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

            - name: Wait for Garnix check
              uses: lewagon/wait-on-check-action@v1.5.0
              with:
                  ref: ${{ steps.push.outputs.commit_sha }}
                  check-regexp: "(packages|Evaluate|All Garnix).*"
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
                  wait-interval: 10 # seconds

            - name: Trigger VPS Update
              if: success()
              env:
                  VPS_DISPATCH_TOKEN: ${{ secrets.NIX_VPS_DISPATCH_TOKEN }}
              run: |
                  curl -L \
                    -X POST \
                    -H "Accept: application/vnd.github+json" \
                    -H "Authorization: Bearer $VPS_DISPATCH_TOKEN" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    https://api.github.com/repos/toxx1220/nix-vps/dispatches \
                    -d '{"event_type":"update-nannuo-bot"}'
